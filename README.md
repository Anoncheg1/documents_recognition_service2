# opencv

 [RNB OpenCV API](https://web.opencv.dev.norma.rnb.com/)

 [RNB OpenCV Dashboard](https://opencv.dev.norma.rnb.com/)

# Оглавление
- [Развёртка](#развёртка)
- [API изменения](#api-изменения)
- [Использование API](#использование-api)
  - [Общие сведения](общие-сведения)
    - [Возможные ответы в методе upload](#Ввзможные-ответы-в-методе-upload)
    - [Возможные ответы в методе get](#возможные-ответы-в-методе-get)
  - [Структура отдаваемого результата JSON при успешной обработке файла](#структура-отдаваемого-результата- json-при-успешной-обработке-файла)
  - [Расшифровка флагов поля валидации qc](#расшифровка-флагов-поля-валидации-qc)
  - [Расшифровка флагов типа документа document_type](#расшифровка-флагов-типа-документа-document_type)
  - [Таймауты основной очереди](#таймауты-основной-очереди)
  - [Структура ответа 140](#структура-ответа-140)
  - [Прогресс распознавания status processing](#прогресс-распознавания-status-processing)
  - [Примеры загрузки файла с помощью метода upload](#Примеры-загрузки-файла-с-помощью-метода-upload)
    - [PHP](#php)
    - [Python](#python)
  - [Пример получения статуса задания с помощью метода get](# пример-получения-статуса-задания-с-помощью-метода-get)
    - [PHP](#php)
    - [Python](#python)
- [Модификация проекта](# модификация-проекта)
- [Архитектура и документация](#архитектура-и-документация)
- [Процессы обработки](#процессы-обработки)
- [Штрихкод расшифрова](#штрихкод-расшифрова)
- [Связь с Core_v2](#связь-с-core_v2)
- [Конфигурация old](#конфигурация-old)
- [Поля в структуре info](#Поля-в-структуре-info)

# Развёртка
Для развертки решения нужны пакеты docker и docker-compose:
```console
docker-compose build && docker-compose up -d
```

# API изменения
- тип документа 49 присоединился к 10
- Тип документа 1000 'Вторая страница многостраничного документа' заменен на тип первой страницы к которой он относится
- для водительского удостоверения 'side' - выводится если qc=3, если qc=4 не выводится

# Известные ошибки
- Водительское удостоверение: поля с текстом помеченные как checked могут быть невалидными - короче чем на самом деле

# Использование API

## Общие сведения

| HTTP метод | URL ресурса       | Примечания                                                                      |
|------------|-------------------|---------------------------------------------------------------------------------|
| GET        | /get?id=\<jobid\> | Отдает статус текущего jobid                                                    |
| GET        | /upload           | Показывает форму загрузки файла, при успешной загрузке переходит к /upload POST |
| POST       | /upload           | Загружает файл с полем "file" и отдает jobid                                    |

### Возможные ответы в методе upload

| Статус | JSON                                                              | Описание                                  |
|--------|-------------------------------------------------------------------|-------------------------------------------|
| Ок     | {"id": "291b9e1e2eff4b34a1690a56b5eefc8e"}                        | Успешная загрузка файла, отдача jobid     |
| Ошибка | {"status": "exception", "description": "file not exists"}         | Файл не был указан файл с полем "pdf"     |
| Ошибка | {"status": "exception", "description": "file is not a .pdf file"} | Загружен файл в формате, отличном от .pdf |

### Возможные ответы в методе get

| HTTP | Статус | JSON                                                        | Описание                                                      |
|--------|--------|-------------------------------------------------------------|---------------------------------------------------------------|
| 200 | Ок     | {"status": "in pool"}                                       | Файл находится в очереди, все worker'ы пока заняты            |
| 200 | Ок     | {"status": "waiting"}                                       | Файл получен worker'ом, и разделяется на страницы             |
| 200 | Ок     | {"status": "processing"}                                    | Файл в процессе обработки, разделение прошло успешно          |
| 200 | Ок     | {"status": "ready", "pages": "..."}                         | Файл обработан, результат обработки доступен по ключу "pages" |
| 400 | Ошибка | {"status": "exception", "description": "key not specified"} | Не был указан jobid при запросе                               |
| 404 | Ошибка | {"status": "exception", "description": "key not exists"}    | Указанный jobid не найден в СУБД Redis - /get и /pdf_pages/get |
| 500 | Ошибка | {"status": "exception", "description": "fail to push task to redis"}  | POST внутренняя ошибка регистрации запроса |

## Структура отдаваемого результата JSON при успешной обработке файла

| Поле          | Тип    | Родитель | Описание                                                                                  |
|---------------|--------|----------|-------------------------------------------------------------------------------------------|
| status        | строка | -        | "ready" - указывает готовность                                                            |
| pages         | список | -        | Информация о каждой странице преобразованного файла pdf или только один эллемент для jpeg |
| qc            | целое  | pages    | [Флаг валидации данных](#Расшифровка-флагов-поля-валидации-qc)                            |
| document_type | целое  | pages    | [Тип распознанного документа](#Расшифровка-флагов-типа-документа-document_type)           |

## Расшифровка флагов поля валидации qc

| Qc | Статус      | Описание                                                                |
|----|-------------|-------------------------------------------------------------------------|
| -1 | Ок          | Для status-processin, распознание страницы не завершено |
| 0  | Ок          | Нет замечаний по содержимому                                            |
| 1  | Ок          | Есть небольшие недочёты, структура не изменена                          |
| 2  | Ок          | Данные распознались плохо, многие поля могут отсутствовать  |
| 3  | Oк          | Ошибка, тип документа определен, но данные не распознаны |
| 4  | Критический | Исключение, тип документа не определен |



## Расшифровка флагов типа документа document_type

| Document_type |                     Описание                    |                     Погрешность                 |
|:-------------:|:-----------------------------------------------:|:------------------------------------------------:|
| 0         | Нераспознано (Исключение)                | |
| 1000         | Вторая страницы (устарела)                  | |
| 100           | Паспорт главная страница                       | |
| 101           | Паспорт не главная страница                    | |
| 110           | ПТС                                             | высокая |
| 120           | Фото                                            | |
| 130           | Водительское удостоверение                      | |
| 140           | Паспорт и Водительское удостоверение   | |
| 80 | Заключение андеррайтера  | |
| 1 | Профессиональное суждение по оценке кредитного риска по ссуде  | |
| 2 | Оценка финансового положения  | |
| 10 | Согласие на обработку персональных данных  | |
| 11 | Договор купли продажи  | |
| 12 | Договор комиссии  | |
| 13 | Агентский договор  | |
| 20 | Акр приема-передачи  | |
| 21 | Приемо-сдаточный акт  | |
| 22 | Счет  | |
| 22 | Счет  | |
| 22 | Счет  | |
| 23 | Квитанция  | высокая |
| 24 | Страховой полис КАСКО  | |
| 24 | Страховой полис КАСКО (КТС)  | |
| 26 | Договор поручения  | |
| 27 | Выписка из электронного паспорта  | |
| 28 | Анкета клиента физлица у партнера  | |
| 40 | Анкета клиента - заемщика банка  | |
| 41 | Заявление на перевод денежных средств со счета ФЛ  | |
| 42 | Заявление о заранее данном акцепте ФЛ  | |
| 43 | Заявление о предоставлении кредита  | |
| 44 | Заявление о подключении онлайн-сервисов РУСНАРБАНК  | |
| 45 | Извещение о присвоении логина  | |
| 46 | Индивидуальные условия  | |
| 47 | Распоряжение о предоставлении кредита  | |
| 48 | Одобрение - сертификат  | |
| 50 | Способы погашения кредита  | |
| 51 | Гарантийное письмо - в автосалон за автомобиль/за дополнительное оборудование  | |
| 53 | Платежное поручение - Основной платежный документ/на оплату КАСКО/на оплату дополнительного оборудования  | |
| 56 | Полис страхования от несчастного случая  | |
| 58 | Памятка к договорам личного страхования  | |
| 59 | Заявление на участие в государственной программе | |
| 60 | Телемедицина | |
| 501 | Анкета-заявление на предоставление кредита. АвтоСпецЦентр  | |

## Таймауты основной очереди
- "in pool" - 700 sec max
- "processing - 900 sec max

## Структура ответа 140
    {'passport_main':{}, 'driving_license':{}}

## Прогресс распознавания status processing
Поля в процентах 0-100:
- page_progress
- full_progress

Ответ сразу после разделения на страницы:
- "status": "processing"
- "progress": {'pages': 10,'current_page': 0,'page_progress': 0, "full_progress": 0}

После определения предварительного типа:
- "status": "processing"
- "progress": {'pages': 10,'current_page': 0,'page_progress': 1, "full_progress": 0}
- "pages":[{'document_type':140, 'page_progress': 1, 'qc': -1}, Null, Null, Null, Null, Null, Null, Null, Null, Null]

После распознавания страницы
- "status": "processing"
- "progress": {'pages': 10,'current_page': 0,'page_progress': 100, "full_progress": 10}
- "pages":[{обычный вывод}, Null, Null, Null, Null, Null, Null, Null, Null, Null]


## Примеры загрузки файла с помощью метода upload

### РНР:
```php
use GuzzleHttp\Client;

$client = new Client([
    "connect_timeout" => 20,
    "read_timeout" => 20,
    "timeout" => 20,
]);

$r = $client->request("POST", "http://127.0.0.1:5000/upload", [
    "multipart" => [
        [
            "name"     => "pdf",
            "filename" => $_FILES["pdf"]["name"],
            "contents" => fopen($_FILES["pdf"]["tmp_name"], 'r')
            ],
        ]
    ]);

return $r->getBody();
```

### Рython:
```python
import requests

files = {'pdf': open(input_file, 'rb')}
job_id = requests.post("http://127.0.0.1:5000/upload", files=files).json()["id"]
print(job_id)
```

## Пример получения статуса задания с помощью метода get

### PHP
```php
use GuzzleHttp\Client;

$client = new Client([
    'connect_timeout' => 20,
    'read_timeout' => 20,
    'timeout' => 20,
]);

//$jobid - id работы, полученный при загрузке файла в /upload
$r = $client->request('GET', 'http://web:5000/get?id='.$jobid);

return $r->getBody();
```


### Python
```python
import requests

#job_id - id работы, полученный при загрузке файла в /upload
result = requests.get(url+"/get?id="+job_id).json()
print(result)
```

# Модификация проекта

- В данный момент используется Large [.traineddata](https://gitlab.rusnarbank.ru/RNB/opencv/blob/master/docker/worker/rus.traineddata) для Tesseract OCR, при желании его можно заменить на какой-либо другой [отсюда](https://github.com/tesseract-ocr/tesseract/wiki/Data-Files)
- При желании можно увеличить количество worker'ов


# Архитектура и документация

Решение содержит 5 контейнеров:
- **Flask API/web** (python:3.7.2-alpine image) + flask c pip - проброс 5000 порта вне Docker;
- **Redis/redis** (redis:alpine);
- **RQ-dashboard/dashboard** (python:3.7.2-alpine) + rq-dashboard с pip - проброс 9181 порта вне Docker;
- **Worker/worker** (debian:bullseye-slim) + opencv + tesseract-ocr + poppler ;
- **Predictor - document type/nn_doctype** (python:3.7-slim) + tensorflow;
- **Predictor - orientation, passport main/nn_second** (python:3.7-slim) + tensorflow;

Redis очереди:
- 0 - web -> worker (file)
- 1 - worker -> web (JSON)
- 2 - worker - > nn_doctype
- 3 - nn_doctype -> worker
- 4 - worker - > nn_second
- 5 - nn_second(orientation_and_passmainimgage) -> worker
- 6 - worker -> web (pdf page files)
- 7 - nn_second(text_or_not) - > worker
- 8 - nn_second(handwrited_or_not) - > worker

under construction Вся документация по исходным кодам на Python находится [здесь](https://gitlab.rusnarbank.ru/RNB/opencv/tree/master/doc)

# Процессы обработки
barcodes_only_upload
1) баркоды распознаются для любой ориентации документа, поэтому никак его не подготавливаем

pages_recognition_simple
1) NN текст или нет
2) если текст - тип по баркодам или определить ориентацию и по тексту тип
3) если не текст - 1 подготавливаем 2 NN для поворота и типа 3 поворачиваем
4) парсер и simplify

# Штрихкод расшифрова
I25 - тип

019912919146
0 - спец символ и 6 чексумма I25
1991291914
9 разделяет на 5 секций
1- версия
' ' - резерв
12 - в 8 ричной системе 10 - тип документа
1 - номер страницы
14 - чексумма

sum = version + reserv + doctype + page
sum % 64 == checksum - где sum и 64 в десятиричной системе.

Можно без 0 в начале.

# Связь с Core_v2
- [Core_v2 типы документов и их номер в баркоде](https://gitlab.rusnarbank.ru/RNB/core_v2/-/blob/development/config/autocredit/documents.yaml)

# Конфигурация old
До развёртки решения необходимо заменить URL подключения к сервису логирования Sentry.IO в файле SentryIOURL.yaml, расположенного по следующему пути:
```
docker
└── worker
    └── yaml
        └── SentryIOURL.yaml
```
